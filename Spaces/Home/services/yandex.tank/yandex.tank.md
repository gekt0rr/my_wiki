# Yandex tank
Способов проверить работу сайта под нагрузкой много от самых примитивных утилит до целых систем. Я покажу конкретный пример нагрузочного тестирования сайта с помощью **Yandex.Tank**. Это бесплатный инструмент с очень большим функционалом и простой в использовании.

## Введение

Для начала приведу несколько полезных ссылок на тему Yandex.Tank. Они все почему-то разрозненные и не связаны логически друг с другом. Функционал этого инструмента обширный, я же рассмотрю достаточно простой пример, поэтому точно пригодится документация.

- Документация - [https://yandextank.readthedocs.io/](https://yandextank.readthedocs.io/)
- Исходники - [https://github.com/yandex/yandex-tank](https://github.com/yandex/yandex-tank)
- Сервис визуализации - [https://overload.yandex.net/](https://overload.yandex.net/)

> [!warning]
> **Первым делом сходите на overload.yandex.net**, зарегистрируйтесь там и получите токен. Он нам нужен будет далее, чтобы в удобном виде просматривать визуализацию результатов. Это не обязательное условие для совершения тестов и можно обойтись без него. Будет простенький вывод в консоли, с помощью которого можно оценить результат нагрузочного тестирования. Но с помощью модуля overload гораздо удобнее и нагляднее интерпретировать полученные данные.

## Установка Yandex.Tank

Для начала установите себе докер, у меня есть статья по теме - [[docker]]. После этого создаем директорию для данных танка и кладем туда конфиг нагрузочного теста для сайта.
```
mkdir ~/yandex.tank && cd yandex.tank
touch load.yaml token.txt
```
пример файла конфигурации `load.yaml`
~~~yaml
phantom:
  address: 10.203.0.51:5080
  uris:
    - /
  load_profile:
    load_type: rps
    schedule: line(5, 30, 1m)
overload:
  enabled: true
  package: yandextank.plugins.DataUploader
  token_file: "token.txt"
autostop:
  autostop:
    - http(5xx,10%,5s)
console:
  enabled: true
telegraf:
  enabled: false
~~~
## Запуск нагрузки на сайта с помощью Yandex.Tank

Запускаем Yandex.Tank:
```
cd ~/yandex.tank
docker run --rm -v ~/yandex.tank:/var/loadtest -it yandex/yandex-tank
```
Ждем окончания тестирования. Если укажите очень большую нагрузку, например в тысячи rps, можете повесить виртуалку или сайт (хе-хе). Вывод работы танка будет примерно такой.

[![Пример настройки Yandex.Tank](https://serveradmin.ru/wp-content/uploads/2020/11/website-test-yandex.tank-01.png)](https://serveradmin.ru/wp-content/uploads/2020/11/website-test-yandex.tank-01.png)

В нагрузочном тестировании сайта нас в первую очередь интересует время отклика. Где его можно оценить, я выделил на скриншоте. После того, как завершится тест, в завершающем выводе работы контейнера будет ссылка на overload, где вы сможете посмотреть результат через браузер.

![Завершение нагрузочного тестирования](https://serveradmin.ru/wp-content/uploads/2020/11/website-test-yandex.tank-02.png)

Пройдя по ней вы сможете более детально изучить поведение сайта под нагрузкой.

[![Просмотр результатов теста yandex.tank в браузере](https://serveradmin.ru/wp-content/uploads/2020/11/website-test-yandex.tank-03.png)](https://serveradmin.ru/wp-content/uploads/2020/11/website-test-yandex.tank-03.png)

Например, на приведенном результате теста четко видно, как при приближении к 25-ти одновременным запросам начинает сильно расти время ответа сервера. На 20-ти запросах в 90-й перцентиль попадали все ответы менее 500 мс, а на 25-ти уже даже в 50-й перцентиль зашли ответы 750 мс.

Имеет смысл походить по вкладкам, там много другой полезной информации. С помощью данного тестирования вы сможете достаточно быстро определить предел производительности вашего железа.

Если хотите смоделировать более реальную нагрузку, а не синтетическую, то хорошенько поработайте над набором тестов и урлов. Можно очень гибко все это настроить. Например, добавить post запросы, где-то нарастающую нагрузку сделать, а где-то постоянную. Все это описано в документации. Там есть сильно навороченные примеры.

## Заключение

С помощью Yandex.Tank вы без проблем можете положить неподготовленный сайт. Главное найти в нем самые медленные и нагруженные места (например поиск или большой каталог) А потом одновременно запустите тест из разных мест. А если еще и хорошенько автоматизируете это с помощью terraform и ansible, то совсем хорошо получится. Или плохо для владельца сайта. Правда это дороговато может стоить, есть способы подешевле. Но сейчас не будем об этом.

От такого рода "тестирования" достаточно просто защититься и стоит это делать всегда. Примеры защиты я подробно описывал в своих статьях - [защита от ddos](https://serveradmin.ru/ddos-ataka-na-sajt-zashhita-ot-ddos/), [защита от dos атак](https://serveradmin.ru/zashhita-web-servera-ot-ddos/). В общем случае достаточно будет стандартных возможностей nginx, iptables и fail2ban. Удивительно, но очень много кто этого не делает. Я ради любопытства иногда клал очень неожиданные сайты. Но только в академических целях и на очень короткий период времени. Помним о карме и не вредим другим людям! Используем инструменты только во благо.