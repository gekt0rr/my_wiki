# Работа с сертификатами
## OpenSSL

### Создание закрытого ключа для корневого сертификата
```
openssl genpkey -algorithm RSA -out rootCA.key -aes256
```
Эта команда создает закрытый ключ для корневого сертификата с помощью утилиты `genpkey` из пакета OpenSSL. 

- `-algorithm RSA` -  указывается алгоритм шифрования
- `-out rootCA.key` - название для файла ключа
- `-aes256` - указывает на использование шифрования AES-256 для защиты закрытого ключа. 

При выполнении команды вам будет предложено ввести пароль для ключа.
### Создание самоподписанного корневого сертификата
```
openssl req -new -x509 -days 3650 -key rootCA.key -out rootCA.crt -subj "/C=US/ST=New York/L=New York/O=Example Inc./OU=IT Department/CN=example.com"
```
Эта команда создает самоподписанный корневой сертификат с помощью утилиты `req` из пакета OpenSSL. 
- `-new` указывает на создание нового сертификата
- `-x509` указывает на создание самоподписанного сертификата 
- `-days 3650` задает срок действия сертификата в днях
- `-key rootCA.key` указывает на использование закрытого ключа, созданного на предыдущем шаге
- `-out rootCA.crt` задает имя файла, в который будет сохранен корневой сертификат
- `-subj` задает информацию о субъекте сертификата в формате `/key=value`. 

В этом примере используется информация о субъекте, указывающая на страну, штат, город, организацию, отдел и имя хоста.

### Создание закрытого ключа для подчиненного сертификата
Ключи такие же как и в создании закрытого ключа для корневого сертификата
```
openssl genpkey -algorithm RSA -out server.key -aes256
```

### Создание запроса на сертификат для подчиненного сертификата
```
openssl req -new -key server.key -out server.csr -subj "/C=US/ST=New York/L=New York/O=Example Inc./OU=IT Department/CN=nextcloud.305-lab.astralnalog.ru"
```
Эта команда создает запрос на сертификат для подчиненного сертификата с помощью утилиты `req` из пакета OpenSSL

- `-new` указывает на создание нового запроса
- `-key server.key` указывает на использование закрытого ключа, созданного на предыдущем шаге
- `-out server.csr` задает имя файла, в который будет сохранен запрос на сертификат
- `-subj` задает информацию о субъекте сертификата в формате `/key=value`

В этом примере используется информация о субъекте, указывающая на страну, штат, город, организацию, отдел иимя хоста для которого будет использоваться сертификат.

### Подписание запроса на сертификат с помощью корневого сертификата
```
openssl x509 -req -in server.csr -CA rootCA.crt -CAkey rootCA.key -CAcreateserial -out server.crt -days 365 -sha256
```
Эта команда подписывает запрос на сертификат с помощью корневого сертификата, созданного на предыдущих шагах

- `-req` указывает на использование запроса на сертификат
- `-in server.csr` указывает на файл с запросом на сертификат
- `-CA rootCA.crt` указывает на файл корневого сертификата
- `-CAkey rootCA.key` указывает на файл закрытого ключа корневого сертификата
- `-CAcreateserial` указывает на создание серийного номера для сертификата
- Результат сохраняется в файле `server.crt`
- `-days 365` задает срок действия сертификата в днях
- `-sha256` указывает на использование алгоритма хэширования SHA-256 для подписи сертификата.

Вы можете повторить последние две команды для каждого сервиса, для которого вам нужен сертификат, заменяя значение `/CN` в каждой команде на соответствующее имя хоста.

### Создание самоподписанного ключа и пары сертификатов OpenSSL
```
sudo openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout /etc/ssl/private/apache-selfsigned.key -out /etc/ssl/certs/apache-selfsigned.crt
```
Эта команда создает самоподписанный ключ и пару сертификатов с помощью утилиты `req` из пакета OpenSSL

- `-x509` указывает на создание самоподписанного сертификата
- `-nodes` указывает на создание незащищенного закрытого ключа
- `-days 365` задает срок действия сертификата в днях
- `-newkey rsa:2048` указывает на создание нового закрытого ключа с длиной 2048 бит
- `-keyout` задает имя файла, в который будет сохранен закрытый ключ
- `-out` задает имя файла, в который будет сохранен сертификат

В этом примере ключ сохраняется в файле `/etc/ssl/private/apache-selfsigned.key`, а сертификат сохраня


## Let's Encrypt

### Запрос сертификата через TXT-запись
```
sudo certbot certonly --manual --agree-tos --email a.basov@zencha.ru --preferred-challenges=dns -d portainer.orbitaferzikovo.ru
```
Эта команда использует Certbot, автоматический инструмент для получения сертификатов Let's Encrypt

- `certonly` указывает на получение только сертификата, без настройки веб-сервера
- `--manual` указывает на выполнение проверки вручную
- `--agree-tos` указывает на принятие условий использования Let's Encrypt
- `--email` задает адрес электронной почты для связи в случае проблем с сертификатом
- `--preferred-challenges=dns` указывает на использование DNS-записи для подтверждения владения доменом
- `-d` задает имя хоста для которого запрашивается сертификат

> [!NOTE]
> Если необходимо выпустить wild-card сертификат, достаточно просто добавить дополнительный параметр `-d "*.portainer.orbitaferzikovo.ru"`. Кавычки необходимы, т.к некоторые интерпретаторы (например fish) не понимают звездочку. 
>
 ```
sudo certbot certonly --manual --agree-tos --email a.basov@zencha.ru --preferred-challenges=dns -d portainer.orbitaferzikovo.ru -d "*.portainer.orbitaferzikovo.ru"
```

При выполнении команды Certbot попросит вас добавить TXT-запись в DNS-зону вашего домена для подтверждения владения доменом.

#  Лайвхаки
## Cкачать текущий SSL сертификат с сайта
Для того, чтобы скачать текущий SSL сертификат, который использует сервер repo.ald-test.local, можно воспользоваться командой openssl:
```
openssl s_client -connect repo.ald-test.local:443 -showcerts </dev/null 2>/dev/null| openssl x509 -outform PEM > repo.crt
```
Разберем что тут происходит:
1. `openssl s_client` устанавливает соединение с сервером по SSL и выводит информацию о сертификате
2. Мы перенаправляем стандартные потоки входа/выхода в никуда, чтобы вернуть только сертификат
3. Вывод передается в `openssl x509`, который преобразует сертификат в формат PEM и сохраняет в файл repo.crt

После этого в текущей директории появится файл repo.crt с содержимым текущего сертификата сервера в PEM формате.

Его можно открыть и посмотреть текст сертификата, имя владельца и так далее.

## Создать самоподписанный сертификат для конкретного CN
Для этого достаточно: 

1. Создать ключ и CSR с нужным CN:
```
openssl genrsa -out repo.key 2048 openssl req -new -key repo.key -out repo.csr -subj "/CN=repo.ald-test.local"
```
2. Подписать CSR этим же ключом (самоподписанный сертификат):
```
openssl x509 -req -days 365 -in repo.csr -signkey repo.key -out repo.crt
```
3. Переместить старый сертификат под новым именем:
```
mv /etc/ssl/certs/repo.crt /etc/ssl/certs/repo.crt.old
```
4. Скопировать новый сертификат и ключ:
```
scp repo.crt repo.key user@repo.ald-test.local:/etc/ssl/certs/
```
5. Перезапустить сервер для применения изменений.

После этого должно заработать!

